# 事务

参考：  
[https://developer.aliyun.com/article/743691](https://developer.aliyun.com/article/743691)  
[https://my.oschina.net/GreenplumCommunity/blog/4722695](https://my.oschina.net/GreenplumCommunity/blog/4722695)

[toc]

## 1. 背景介绍

### (1). 什么是事务

事务：将应用程序的多个读、写操作捆绑在一起成为一个逻辑操作单元

因此事务中的所有读写是一个执行的整体，整个事务要么成功（提交）、要么失败（终止或回滚）

### (2). 要解决的问题

如系统崩溃所涉及到的数据问题（清理已经执行了一半的数据），如果没有事务的话则不能重试

多个客户提交的请求由于存在竞争关系导致的各种奇怪问题

## 2. ACID

ACID指的是事务所提供的安全保证

### (1). 原子性(Atomicity)

通常，原子是指不可分解为更小粒度的东西

原子性指的是把包含多个写操作的请求打包在一起，这些操作会一起提交成功或回撤

e.g. 用于解决数据回撤的问题

### (2). 一致性(Consistency)

一致性指对数据库的一些恒等约束条件，只要操作没有违背这些约束条件，则操作结果依然满足这些约束条件

### (3). 隔离性(Isolation)

多个用户访问相同数据可能会出现并发问题（存在竞争条件），而隔离性指的是这些事务之间所访问的资源不能存在交叉

### (4). 持久性(Durability)

持久性指一旦事务提交成功，那么就意味着这些数据已经被数据库存储到安全可靠的地方了

## 3. 弱隔离级别

### (1). 读-提交

读-提交是最基本的事务隔离级别，它只提供以下两个保证：

- ==读数据库时，只能看到已成功提交的数据（防止“脏读”）==
- ==写数据库时，只会覆盖已成功提交的数据（防止“脏写”）==

#### ①脏读

如果事务A已经完成了部分数据的写入，但事务尚未提交或终止，此时如果事务B能够看到事务A未提交的改动，则此时就是脏读

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/D3381BFDC529455FA587CA8A66365F23/113662)

#### ②脏写

如果事务A和事务B同时尝试更新==相同==的对象，A事务先写入了一些尚未提交的数据，但B事务会覆盖掉之前A事务的一些数据，则此时就是脏写

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/A3ADDB8C021B49ABB90B8AE3B3AA6957/113687)

#### ③如何实现读-提交

通常采用行级锁的方式来防止脏读和脏写

1. 防止脏写：当事务想修改某个对象时，首先必须要获得该对象的锁，然后一直持有该锁直到事务提交（或终止）。如果有其他事务尝试更新同一个对象，则必须等待前一个事务提交（或终止）之后，才能获得锁并继续。
2. 防止脏读：读和写使用相同的锁，只有当修改的事务完成并释放锁之后，读事务才可以读取数据，从而避免读一个脏的、未提交的值

但是上述方案在实际中并不常见，因为修改的事务会使所有读取该数据的事务进入到等待状态，这会大大降低事务的响应时间；而且对于脏写，会产生死锁的问题

因此实际过程中会使用如下方法（快照）：==对于每个待更新的对象，数据库都会维护旧值和当前事务修改的新值这两个版本。在事务提交之前，所有其他读操作都读取的是旧值；仅当写事务提交完成后，才会切换到读取新值==

读-提交隔离并不能解决下面的计数器增量竞争情况，因为虽然是在上一个用户提交完之后做的修改，但是从结果上来看依然会覆盖之前的数据

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/6D5EDA8D264F44079B972B05DE43D239/113693)

### (2). 可重复读

#### ①可重复读举例

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/2B95D7A273B14F3699D7F092B654F9D0/113771)

此时并不违反脏读的限定

#### ②通过快照级别隔离解决上述问题

每个读取事务总是从数据库的一致性快照中读取，因此不需要加锁；如果有事务要修改，则需要写锁来避免脏写的问题。

这样就可以提高读取的并行度，从而提高性能，也能够避免可重复读的问题

读-提交级别的快照隔离是针对两个事务的情况，即一个旧版本和一个尚未提交的新版本就够了。但是如果有多个事务并发执行，则需要保留对象的多个不同提交版本，这种技术称之为==多版本并发控制(MVCC)==

#### ③快照级别隔离举例

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/53B4BA9EF3174DD68AF1D4BDEE224503/113811)

当事务要开始做修改时，首先给该事务赋予一个唯一的、单调递增的事务ID(txid)。当事务要对数据库做修改时，会把所有要修改的数据都标记到该写入者的事务ID中。当数据库确认该修改操作没有和之前的修改有竞争时，就会实际执行该操作，否则将放弃该快照

### (3). 写倾斜与幻读

#### ①写倾斜举例

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/175F60EB512C4B89B278432F6873F634/113863)

#### ②什么是写倾斜

事务首先查询数据库，根据返回的结果进行判断是否要修改数据。当事务修改完成并提交时，之前的判断条件已经不再成立。

两个事务读取相同的一组对象，然后分别更新其中一部分。如果不同的事务更新==不同的部分==，则可能发生写倾斜。如果不同的事务更新的是==同一个对象==，则可能发生脏写。

出现写倾斜的原因是前一个事务的写入操作改变了另一个事务的查询结果，而这种现象称之为幻读。

解决上述问题的一般思路就是串行化

## 4. 可串行化

### (1). 可串行化简介

可串行化被认为是最强的隔离级别。它能够保证事务可能会发生并行执行，但最终的结果与串行执行结果是一致的。

目前大多数提供可串行化的数据库都使用了以下三种技术之一：

- 严格按照串行执行
- 两阶段锁定（悲观锁）
- 乐观并发控制技术（例如可串行化的快照隔离）

### (2). 严格按照串行执行

解决并发问题最直接的方法是避免并发：在一个线程上岸顺序方式每次只执行一个事务。其对应的隔离级别一定是严格串行化的

### (3). 两阶段加锁(2PL)

回顾：之前是使用加锁的方式防止脏写，即如果两个事务同时尝试写入同一个对象，可以用加锁的方式来确保第二个写入事务等待前面的事务完成

两阶段加锁方式类似，但强制性更高。多个事务可以同时读取同一个对象，但==只要出现写操作（包括修改和删除），则必须加锁以独占访问==

2PL不仅在并发写之间互斥，读取和写入之间也会互斥

虽然可以解决之前的所有问题，但其性能差强人意

### (4). 可串行化的快照隔离

#### ①两阶段加锁——悲观锁

两阶段加锁是一种典型的悲观并发控制机制，如果某些操作可能会出错（例如与其他并发事务发生了锁冲突），那么直接放弃，采用等待方式直到绝对安全

某种意义上，串行执行是一种极端悲观的选择：事务执行期间，等价于事务对整个数据库（或数据库的一个分区）持有互斥锁

#### ②可串行化的快照隔离——乐观锁

相比之下，可串行化的快照隔离则是一种乐观并发控制。因为如果发生潜在冲突，事务会继续执行而不是终止，只有当事务提交时数据库才会检查是否确实发生了冲突，如果是的话才会终止事务并重试

1. 读-提交隔离级别：事务中的每条SQL语句都会获得一个快照
2. 可重复读隔离级别：事务只在第一条SQL语句的执行时获取一个快照
3. 可串行化快照隔离：

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/B5352801F7D24B819E0007208CCD0FA5/114109)

每一个顶点代表一个事务，有三种情况：写读依赖(rw-dependency)、写写依赖(ww-dependency)、读写反依赖(rw-confict)

如果这些事务所构成的图形成一个有向环，那么这些事务是无法对应一个可串行化调度的

## 5. 隔离级别小结

事务隔离级别 | 脏读、脏写 | 不可重复度 | 幻读
---|---|---|---
读未提交 | 可能 | 可能 | 可能 
读已提交 | 不会 | 可能 | 可能
可重复读 | 不会 | 不会 | 可能
可串行化 | 不会 | 不会 | 不会

![](https://note.youdao.com/yws/public/resource/c28a9b83b8f275f19bcabe7447482401/xmlnote/E6885548620E4B3CA68B92E8ED501F7B/114123)

